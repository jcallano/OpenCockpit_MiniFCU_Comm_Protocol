# MiniFCU / MiniEFIS Interface Protocol Specification
Version: 3.0 (Community Extended Edition)
Based on: Reverse engineering, serial sniffing, and flight-cycle analysis.

## 1. PHYSICAL LAYER & CONNECTION
* **Interface:** USB Serial (CH340 chipset)
* **Baud Rate:** 9600 bps
* **Data Bits:** 8 | **Parity:** None | **Stop Bits:** 1
* **Flow Control:** None
* **Signal Requirement:** DTR and RTS lines must be asserted (TRUE/High) for the microcontroller to power up.

---

## 2. PROTOCOL OVERVIEW
The communication is bidirectional, ASCII-based, and event-driven.

* **PC to Hardware (Output):** Commands end with a comma `,`.
    * *Example:* `A23000,` (Set Altitude to 23000)
* **Hardware to PC (Input):** Events end with a semicolon `;`.
    * *Example:* `17;` (Altitude Encoder increment)

### 2.1 Communication Philosophy
* **Stateless Hardware:** The MiniFCU hardware does not calculate values. It only reports physical actions (clicks/rotations).
* **PC Authority:** The PC software is responsible for maintaining logic, values, and refreshing the display.
* **Heartbeat Criticality:** Unlike previous assumptions, the hardware **requires** a heartbeat signal (`6,`) to stay active and will respond with a status echo (`9xx;`).

---

## 3. SYSTEM COMMANDS (PC -> HW)
*Crucial for initialization and keeping the device alive.*

| Command | Description | Usage / Frequency |
| :--- | :--- | :--- |
| **C,** | **Connect / Handshake** | Sent once at session start. Triggers Firmware ID response. |
| **6,** | **Heartbeat / Keep-alive** | **CRITICAL.** Must be sent every ~500ms-1s. Hardware responds with `9xx` burst. |
| **Bxxx,** | **Backlight Intensity** | `B1000,` (Max Brightness), `B100,` (Dimmed). |
| **9,** | **Reset / Wake** | Observed during initialization bursts. |

---

## 4. INITIALIZATION SEQUENCE (Recommended)
To ensure correct operation, the driver should follow this sequence upon connection:

1.  Assert DTR/RTS.
2.  Send `C,` (Wait for `901;` response).
3.  Send Limits (observed in dump): `[6000,` `]-6000,` `n49000,`.
4.  Send Initial Brightness: `B1000,`.
5.  Begin Main Loop (Poll inputs, send `6,` heartbeat, update displays).

---

## 5. INPUTS (HARDWARE -> PC)
*Events generated by user interaction.*

### 5.1 Encoders (Rotary Knobs)
*Note: Rapid rotation may produce bursts of commands.*

| Function | Increment (CW) | Decrement (CCW) | Push | Pull |
| :--- | :---: | :---: | :---: | :---: |
| **Speed** | `13;` | `14;` | `11;` | `12;` |
| **Heading** | `3;` | `4;` | `1;` | `2;` |
| **Altitude** | `17;` | `18;` | `15;` | `16;` |
| **V/S** | `21;` | `22;` | `19;` | N/A |

### 5.2 Barometer (QNH)
The QNH encoder behaves differently, sending absolute values or specific source IDs.
* **Format:** `101,value;` OR `102,value;`
* *Note: Driver should parse both `101` and `102` as valid QNH inputs.*

### 5.3 Buttons (Momentary)
| Button | Code | Button | Code |
| :--- | :--- | :--- | :--- |
| **AP1** | `50;` | **FD** | `62;` |
| **AP2** | `51;` | **LS** | `63;` |
| **A/THR** | `52;` | **CSTR** | `64;` |
| **LOC** | `53;` | **WPT** | `65;` |
| **EXPED** | `54;` | **VOR.D** | `66;` |
| **APPR** | `55;` | **NDB** | `67;` |
| **OFF (Alt)**| `10;` | **ARPT** | `68;` |

### 5.4 System Responses (HW -> PC)
* **`9xx;` Series (Heartbeat Echo):** Sent by HW in response to `6,`.
    * Examples: `952;` (A/THR Active), `962;` (FD Active).
    * *Interpretation:* Hardware reporting currently lit LEDs back to PC.
* **Firmware IDs:** `901;`, `956;`, `959;` (Sent after `C,`).

---

## 6. OUTPUTS (PC -> HARDWARE)
*Commands to update displays and LEDs.*

### 6.1 7-Segment Displays
| Display | Command Format | Example |
| :--- | :--- | :--- |
| **Speed** | `Sxxx,` | `S250,` |
| **Heading** | `Hxxx,` | `H180,` |
| **Altitude** | `Axxxxx,` | `A32000,` |
| **Vertical Speed**| `Vxxxx,` | `V-1500,` |
| **QNH** | `#xxxx,` | `#1013,` |

### 6.2 LCD Segments & Managed Modes
| Feature | Command | Description |
| :--- | :--- | :--- |
| **Speed Dot** | `z,` (ON) / `x,` (OFF) | Managed Speed indicator |
| **Hdg Dot** | `m,` (ON) / `s,` (OFF) | Managed Heading indicator |
| **Alt Dot** | `a,` (ON) / `b,` (OFF) | Managed Altitude indicator |
| **Speed Dashes** | `d,` | Displays `---` on Speed window |
| **Hdg Dashes** | `h,` | Displays `---` on Heading window |
| **Alt/VS Dashes**| `D,` | Displays `---` (observed in dump for Alt/VS) |
| **Icons/Flags** | `w,`, `v,`, `q,` | Auxiliary LCD segments (LVL/CH, V/S, etc.) |

### 6.3 LEDs (Illumination)
*Logic: Upper Case = ON, Lower Case = OFF*

| LED | ON | OFF | LED | ON | OFF |
| :--- | :-: | :-: | :--- | :-: | :-: |
| **AP1** | `P,` | `p,` | **FD** | `51,`| `50,`|
| **AP2** | `U,` | `u,` | **LS** | `41,`| `40,`|
| **A/THR** | `T,` | `t,` | **CSTR** | `31,`| `30,`|
| **LOC** | `L,` | `l,` | **WPT** | `21,`| `20,`|
| **EXPED** | `E,` | `e,` | **VORD** | `11,`| `10,`|
| **APPR** | `R,` | `r,` | **NDB** | `01,`| `00,`|
| | | | **ARPT** | `!1,`| `!0,`|

---

## 7. CONFIGURATION LIMITS (PC -> HW)
*Sent during initialization to define display/encoder boundaries.*

* `[6000,` : Set Max Positive V/S (+6000)
* `]-6000,`: Set Max Negative V/S (-6000)
* `n49000,`: Set Max Altitude (49000 ft)

---

## 8. KNOWN ISSUES / NOTES
1.  **Parsing Strategy:** Always buffer input until `;` is received. Do not rely on fixed lengths.
2.  **Burst Handling:** The hardware may send multiple commands in one packet (e.g., `99;95;952;`). The parser must split by `;`.
3.  **Ambiguity:** Commands like `B100` vs `B1000`. Parsers must respect the comma delimiter `,` to distinguish valid commands.
